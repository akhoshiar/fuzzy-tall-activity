<script>
// ================== Membership functions ==================
function gaussmf(x, sigma, c) {
  var d = x - c;
  return Math.exp(-(d * d) / (2 * sigma * sigma));
}
function trapmf(x, a, b, c, d) {
  if (x <= a || x >= d) return 0;
  if (x >= b && x <= c) return 1;
  if (x > a && x < b)  return (x - a) / (b - a);
  return (d - x) / (d - c);
}
function trimf(x, a, b, c) {
  if (x <= a || x >= c) return 0;
  if (x === b) return 1;
  if (x > a && x < b) return (x - a) / (b - a);
  return (c - x) / (c - b);
}

// Fuzzy operators (make them explicit)
function fuzzyOr(a, b)  { return Math.max(a, b); }      // OR  -> max
function fuzzyAnd(a, b) { return Math.min(a, b); }      // AND -> min
function fuzzyNot(a)    { return 1 - a; }               // NOT -> 1-a

// ================== Fuzzy inference ==================
function evalFuzzyTip(service, food) {
  // ---- 1. Fuzzification of inputs ----
  var poor      = gaussmf(service, 1.5, 0);
  var good      = gaussmf(service, 1.5, 5);
  var excellent = gaussmf(service, 1.5, 10);

  var rancid    = trapmf(food, 0, 0, 2, 4);
  var fine      = trapmf(food, 2, 4, 6, 8);         // not used in rules but defined
  var delicious = trapmf(food, 6, 8, 10, 10);

  // ---- 2. Rule firing strengths (antecedents) ----
  // R1: If service is poor OR food is rancid      -> tip is low
  // R2: If service is good                        -> tip is average
  // R3: If service is excellent OR food delicious -> tip is high
  var r1 = fuzzyOr(poor, rancid);          // low
  var r2 = good;                           // average
  var r3 = fuzzyOr(excellent, delicious);  // high

  // ---- 3. Aggregation & defuzzification (Mamdani + centroid) ----
  var xMin = 0, xMax = 30, n = 600;
  var step = (xMax - xMin) / (n - 1);
  var sumNum = 0, sumDen = 0;

  var xTipValues = [];
  var muAggValues = [];

  for (var i = 0; i < n; i++) {
    var x = xMin + i * step;

    // Output membership functions
    var muLow     = trimf(x, 0, 5, 15);
    var muAverage = trimf(x, 5, 15, 25);
    var muHigh    = trimf(x, 15, 25, 30);

    // Implication: clip each MF by its rule firing strength (AND = min)
    var lowClip  = fuzzyAnd(r1, muLow);
    var avgClip  = fuzzyAnd(r2, muAverage);
    var highClip = fuzzyAnd(r3, muHigh);

    // Aggregation over rules: OR of all contributions at this x â†’ max
    var muAgg = Math.max(lowClip, avgClip, highClip);

    xTipValues.push(x);
    muAggValues.push(muAgg);

    sumNum += x * muAgg;
    sumDen += muAgg;
  }

  var tip = (sumDen > 0) ? (sumNum / sumDen) : 0;

  return {
    tip: tip,
    rule1: r1,
    rule2: r2,
    rule3: r3,
    xTip: xTipValues,
    muAgg: muAggValues
  };
}

// ================== Canvas drawing ==================
function drawTipCanvas(ctx, tipResult) {
  var w = ctx.canvas.width;
  var h = ctx.canvas.height;

  ctx.clearRect(0,0,w,h);

  var left = 40, right = 10, bottom = 30, top = 10;
  var plotW = w - left - right;
  var plotH = h - top - bottom;

  function xToPx(x)  { return left + (x / 30) * plotW; }
  function yToPy(mu) { return top + (1 - mu) * plotH; }

  // Axes
  ctx.strokeStyle = "#444";
  ctx.lineWidth   = 1;
  ctx.beginPath();
  ctx.moveTo(left, top + plotH);
  ctx.lineTo(left + plotW, top + plotH);
  ctx.moveTo(left, top);
  ctx.lineTo(left, top + plotH);
  ctx.stroke();

  // X ticks
  ctx.font = "10px system-ui";
  ctx.textAlign = "center";
  ctx.textBaseline = "top";
  for (var x = 0; x <= 30; x += 5) {
    var px = xToPx(x);
    ctx.beginPath();
    ctx.moveTo(px, top + plotH);
    ctx.lineTo(px, top + plotH + 4);
    ctx.stroke();
    ctx.fillText(x.toString(), px, top + plotH + 6);
  }
  // Axis labels
  ctx.save();
  ctx.translate(12, h/2);
  ctx.rotate(-Math.PI/2);
  ctx.textAlign = "center";
  ctx.textBaseline = "middle";
  ctx.fillText("Degree of membership", 0, 0);
  ctx.restore();
  ctx.textAlign = "center";
  ctx.textBaseline = "bottom";
  ctx.fillText("Tip (%)", left + plotW/2, h - 2);

  // Helper to draw triangular MFs
  function drawTrimf(color, a,b,c) {
    ctx.strokeStyle = color;
    ctx.lineWidth   = 1.5;
    ctx.beginPath();
    ctx.moveTo(xToPx(a), yToPy(0));
    ctx.lineTo(xToPx(b), yToPy(1));
    ctx.lineTo(xToPx(c), yToPy(0));
    ctx.stroke();
  }

  // Base MFs
  drawTrimf("#4c6fff", 0, 5, 15);   // low
  drawTrimf("#ff9f1c", 5, 15, 25);  // average
  drawTrimf("#2ec4b6", 15, 25, 30); // high

  // Aggregated polygon
  ctx.beginPath();
  var started = false;
  for (var i = 0; i < tipResult.xTip.length; i++) {
    var x = tipResult.xTip[i];
    var mu = tipResult.muAgg[i];
    if (mu <= 0) continue;
    var px = xToPx(x);
    var py = yToPy(mu);
    if (!started) {
      ctx.moveTo(px, yToPy(0));
      started = true;
    }
    ctx.lineTo(px, py);
  }
  if (started) {
    ctx.lineTo(xToPx(tipResult.xTip[tipResult.xTip.length-1]), yToPy(0));
    ctx.closePath();
    ctx.fillStyle = "rgba(0,0,0,0.06)";
    ctx.fill();
  }

  // Centroid line & marker
  var tip = tipResult.tip;
  var pxTip = xToPx(tip);
  ctx.setLineDash([5,4]);
  ctx.strokeStyle = "#aa0000";
  ctx.lineWidth   = 1.2;
  ctx.beginPath();
  ctx.moveTo(pxTip, top);
  ctx.lineTo(pxTip, top + plotH);
  ctx.stroke();
  ctx.setLineDash([]);

  // Pick mu at tip for marker
  var idx   = Math.round(tip / 30 * (tipResult.xTip.length - 1));
  var muTip = tipResult.muAgg[idx];
  var pyTip = yToPy(muTip);

  ctx.fillStyle = "#ff3333";
  ctx.beginPath();
  ctx.arc(pxTip, pyTip, 4, 0, 2*Math.PI);
  ctx.fill();
}

// ================== UI wiring ==================
var serviceSlider = document.getElementById("serviceSlider");
var foodSlider    = document.getElementById("foodSlider");
var serviceValLbl = document.getElementById("serviceVal");
var foodValLbl    = document.getElementById("foodVal");
var tipOutputLbl  = document.getElementById("tipOutput");
var domLabel      = document.getElementById("domLabel");
var r1Lbl = document.getElementById("r1Val");
var r2Lbl = document.getElementById("r2Val");
var r3Lbl = document.getElementById("r3Val");
var tipCanvas = document.getElementById("tipCanvas");
var ctx = tipCanvas.getContext("2d");

function update() {
  var s = parseFloat(serviceSlider.value);
  var f = parseFloat(foodSlider.value);
  serviceValLbl.textContent = s.toFixed(1);
  foodValLbl.textContent    = f.toFixed(1);

  var res = evalFuzzyTip(s, f);
  var tip = res.tip;

  tipOutputLbl.textContent = "Tip = " + tip.toFixed(1) + " %";

  // Dominant output label (for explanation)
  var muLow     = trimf(tip, 0,5,15);
  var muAverage = trimf(tip, 5,15,25);
  var muHigh    = trimf(tip, 15,25,30);
  var maxMu = Math.max(muLow, muAverage, muHigh);
  var label = (maxMu === muLow) ? "low" :
              (maxMu === muAverage) ? "average" : "high";
  domLabel.textContent = "Dominant output set: " + label;

  // Show rule firing strengths
  r1Lbl.textContent = res.rule1.toFixed(2);
  r2Lbl.textContent = res.rule2.toFixed(2);
  r3Lbl.textContent = res.rule3.toFixed(2);

  drawTipCanvas(ctx, res);
}

serviceSlider.addEventListener("input", update);
foodSlider.addEventListener("input", update);

// initial draw
update();
</script>
